<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Zoomify — Single image (Microscopy)</title>
  <script src="openseadragon/openseadragon.min.js"></script>
  <script src="openseadragon/openseadragon-scalebar.js"></script>
  <style>
    html, body { height: 100%; margin: 0; background:#111; color:#fff; font:14px/1.35 system-ui, Arial, sans-serif; }
    #osd { position:absolute; inset:0; }
    #err {
      position:absolute; bottom:10px; left:50%; transform:translateX(-50%);
      background:rgba(200,0,0,.25); border:1px solid rgba(255,80,80,.5);
      padding:6px 10px; border-radius:6px; max-width:90vw; font-size:12px; display:none;
      white-space:pre-wrap;
    }
  </style>
</head>
<body>
  <div id="osd"></div>
  <div id="err"></div>

  <script>
    // ── QUICK CONFIG ───────────────────────────────────────────────────────────
    const FOLDER = "Run68TR_top_right_downsample2fold_zoomify"; // your Zoomify folder
    const PIXELS_PER_MICRON = 4.0226;                           // px / µm
    // ──────────────────────────────────────────────────────────────────────────

    const errEl = document.getElementById('err');
    const PIXELS_PER_METER = PIXELS_PER_MICRON * 1e6;

    // Load Zoomify ImageProperties.xml (libvips writes it with this exact name)
    async function loadZoomifyProps(baseDir) {
      const url = `${baseDir}/ImageProperties.xml`;
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
      const xmlText = await res.text();
      const xml = new DOMParser().parseFromString(xmlText, "text/xml");
      const props = xml.getElementsByTagName("IMAGE_PROPERTIES")[0];
      if (!props) throw new Error("Missing <IMAGE_PROPERTIES> in ImageProperties.xml");
      const width    = parseInt(props.getAttribute("WIDTH"));
      const height   = parseInt(props.getAttribute("HEIGHT"));
      const tileSize = parseInt(props.getAttribute("TILESIZE")) || 256;
      return { width, height, tileSize };
    }

    // Detect whether tiles are .jpg or .png by probing the first tile
    async function detectFileFormat(baseDir) {
      const probe = async (ext, method="HEAD") => {
        const url = `${baseDir}/TileGroup0/0-0-0.${ext}`;
        try {
          const res = await fetch(url, { method, cache: "no-store" });
          return res.ok;
        } catch { return false; }
      };
      if (await probe("jpg")) return "jpg";
      if (await probe("png")) return "png";
      if (await probe("jpg", "GET")) return "jpg";
      if (await probe("png", "GET")) return "png";
      return "jpg"; // fallback
    }

    (async () => {
      try {
        const props = await loadZoomifyProps(FOLDER);
        const fileFormat = await detectFileFormat(FOLDER);

        const tileSource = {
          type: "zoomifytileservice",
          tilesUrl: FOLDER + "/",
          width: props.width,
          height: props.height,
          tileSize: props.tileSize,
          fileFormat
        };

        const viewer = OpenSeadragon({
          id: 'osd',
          prefixUrl: 'openseadragon/images/',
          tileSources: [tileSource],
          sequenceMode: false,
          preserveViewport: true,
          showNavigator: false,
          maxZoomPixelRatio: 2.0,  // bump if you want more over-zoom
          visibilityRatio: 1.0
        });

        // Microscopy scalebar
        viewer.scalebar({
          type: OpenSeadragon.ScalebarType.MICROSCOPY,
          pixelsPerMeter: PIXELS_PER_METER,
          minWidth: "120px",
          xOffset: 12,
          yOffset: 12,
          location: OpenSeadragon.ScalebarLocation.BOTTOM_LEFT,
          stayInsideImage: true,
          color: "#ffffff",
          fontColor: "#ffffff",
          backgroundColor: "rgba(0,0,0,0.5)",
          barThickness: 3
        });

        // Error helpers
        viewer.addHandler('tile-load-failed', (e) => {
          errEl.style.display = 'block';
          errEl.textContent = `Tile failed: ${e.message || 'HTTP error'} — ${e.tile?.url || ''}`;
          console.error('Tile failed', e);
        });
        viewer.addHandler('open-failed', (e) => {
          errEl.style.display = 'block';
          errEl.textContent = `Open failed: ${e.message || 'unknown error'}`;
          console.error('Open failed', e);
        });
      } catch (e) {
        errEl.style.display = 'block';
        errEl.textContent = e.message;
        console.error(e);
      }
    })();
  </script>
</body>
</html>
